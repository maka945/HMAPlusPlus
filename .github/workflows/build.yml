name: Build HMA++ Module

on:
  workflow_dispatch:
  push:
    branches: [main]

jobs:
  build:
    runs-on: ubuntu-22.04
    
    steps:
    - uses: actions/checkout@v4
    
    - name: Install dependencies
      run: |
        sudo apt-get update
        sudo apt-get install -y \
          build-essential \
          clang-14 llvm-14 lld-14 \
          libelf-dev \
          git wget unzip \
          python3 python3-pip \
          bc flex bison
        
    - name: Get KernelSU builder
      run: |
        # Method 1: Direct download
        wget -q https://codeload.github.com/tiann/kernelsu_builder/zip/refs/heads/main -O builder.zip
        unzip -q builder.zip
        mv kernelsu_builder-main kernelsu_builder
        echo "Builder downloaded successfully"
        
    - name: Prepare module
      run: |
        # Ensure module.json exists
        if [ ! -f "module.json" ]; then
          echo '{
            "id": "hma-plus-plus",
            "name": "HMA++",
            "version": "1.0.0",
            "author": "maka945",
            "minKernelSU": "v0.7.0"
          }' > module.json
        fi
        
    - name: Run builder
      run: |
        cd kernelsu_builder
        python3 builder.py --module ../ --target aarch64
        
    - name: Check results
      run: |
        echo "Build output:"
        ls -la kernelsu_builder/out/ 2>/dev/null || echo "No output directory"
        find . -name "*.kpm" -type f 2>/dev/null || echo "No KPM files found"
        
    - name: Upload KPM file
      uses: actions/upload-artifact@v4
      with:
        name: HMA-Module
        path: |
          kernelsu_builder/out/*.kpm
          *.kpm
        if-no-files-found: warn